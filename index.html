<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Web App Cek Selisih Alfamart</title>
<style>
 body {
   font-family: Arial, sans-serif;
   background: #f4f4f4;
   margin: 0;
   padding: 20px;
 }
 .container {
   max-width: 600px;
   margin: auto;
   background: #ffffff;
   padding: 20px;
   border-radius: 12px;
   box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
 }
 h2 {
   text-align: center;
   color: #333;
 }
 label {
   font-weight: bold;
   display: block;
   margin-top: 15px;
 }
 input, select {
   width: 100%;
   padding: 12px;
   margin-top: 6px;
   border-radius: 8px;
   border: 1px solid #ccc;
 }
 button {
   width: 100%;
   padding: 14px;
   background: #ff3131;
   border: none;
   margin-top: 20px;
   font-size: 18px;
   color: #fff;
   border-radius: 10px;
   cursor: pointer;
 }
 button:hover {
   background: #cc0000;
 }
 iframe {
   width: 100%;
   height: 480px;
   border-radius: 10px;
   margin-top: 20px;
   border: 1px solid #ddd;
 }
 .link-box {
   background: #eef5ff;
   padding: 10px;
   border-radius: 8px;
   margin-top: 15px;
   word-break: break-all;
 }
 .history-box {
   margin-top: 20px;
   background: #fff9e6;
   padding: 12px;
   border-radius: 10px;
 }
 .history-item {
   margin-bottom: 6px;
   font-size: 14px;
 }
</style>
</head>
<body>
<div class="container">
<h2>Cek Selisih Last SO</h2>

<label>Tanggal SO:</label>
<input type="date" id="dateSo" />

<label>Kode Toko (storeId):</label>
<select id="storeId">
  <option value="">-- Pilih Toko --</option>
</select>

<button onclick="generateURL()">Cek Selisih</button>

<div id="output"></div>
<div id="riwayat" class="history-box" style="display:none;"></div>
</div>

<script>
// =================== Fitur: Generate Dropdown Toko ===================
const storeDropdown = document.getElementById("storeId");
for (let i = 1; i <= 999; i++) {
  const id = `L${String(i).padStart(3, "0")}`;
  const opt = document.createElement("option");
  opt.value = id;
  opt.textContent = id;
  storeDropdown.appendChild(opt);
}

// =================== Fitur: Auto-set tanggal hari ini ===================
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, "0");
const dd = String(today.getDate()).padStart(2, "0");
document.getElementById("dateSo").value = `${yyyy}-${mm}-${dd}`;

// =================== Fitur: History ===================
function saveHistory(url) {
  let data = JSON.parse(localStorage.getItem("historySelisih") || "[]");
  data.unshift({ url: url, time: new Date().toLocaleString() });
  if (data.length > 10) data.pop();
  localStorage.setItem("historySelisih", JSON.stringify(data));
  renderHistory();
}

function renderHistory() {
  const box = document.getElementById("riwayat");
  const data = JSON.parse(localStorage.getItem("historySelisih") || "[]");

  if (data.length === 0) {
    box.style.display = "none";
    return;
  }

  box.style.display = "block";
  box.innerHTML = "<h4>Riwayat Pencarian</h4>" + data
    .map(
      (x) => `
        <div class='history-item'>
          <strong>${x.time}</strong><br>
          <a href="${x.url}" target="_blank">${x.url}</a>
        </div>`
    )
    .join("");
}
renderHistory();

// =================== Fitur: Generate URL & tampilkan iframe ===================
function generateURL() {
  const dateSo = document.getElementById("dateSo").value;
  const storeId = document.getElementById("storeId").value;

  if (!dateSo || !storeId) {
    alert("Harap isi tanggal dan pilih kode toko!");
    return;
  }

  const parts = dateSo.split("-");
  const finalDate = `${parts[2]}-${parts[1]}-${parts[0]}`;

  const finalURL = `https://app.alfastore.co.id/prd/api/rpt/laporan_so/csel_last_so_absolute_desc?storeId=${storeId}&dateSo=${finalDate}`;

  document.getElementById("output").innerHTML = `
    <div class='link-box'>
      <strong>Link Hasil:</strong><br>
      <a href="${finalURL}" target="_blank">${finalURL}</a>
    </div>
    <iframe src="${finalURL}"></iframe>
  `;

  saveHistory(finalURL);
}
</script>
</body>
</html>
